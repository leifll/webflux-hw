apiVersion: apps/v1
kind: Deployment
metadata:
  name: webflux-hw-deployment
  namespace: apps
  labels:
    app: webflux-hw-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: webflux-hw-pod
  template:
    metadata:
      labels:
        app: webflux-hw-pod
    spec:
      containers:
        - name: webflux-hw-container
          image: ghcr.io/leifll/webflux-hw:main-1b031bd-20211116131637587845256 # {"$imagepolicy": "apps:webflux-hw-imagepolicy"}
          ports:
            - containerPort: 8080
# ---
# Generated by flagger Canary
# kind: Service
# apiVersion: v1
# metadata:
#   name: webflux-hw-service
#   namespace: apps
# spec:
#   selector:
#     app: webflux-hw-pod
#   ports:
#     - name: http-webflux-hw-port
#       port: 80
#       targetPort: 8080
# ---
# Generated by flagger Canary
# apiVersion: networking.istio.io/v1alpha3
# kind: VirtualService
# metadata:
#   name: webflux-hw-virtualservice
#   namespace: apps
# spec:
#   hosts:
#     - 'webflux-hw.leiflindback.se'
#   gateways:
#     - istio-system/public-gateway
#   http:
#     - match:
#         - uri:
#             prefix: /webflux-hw
#       route:
#         - destination:
#             port:
#               number: 80
#             host: webflux-hw-service.apps.svc.cluster.local
---
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: webflux-hw-canary
  namespace: apps
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: webflux-hw-deployment
  # autoscalerRef: Add when k8s HPA has been created
  #   apiVersion: autoscaling/v2beta2
  #   kind: HorizontalPodAutoscaler
  #   name: webflux-hw-autoscaler
  service:
    # name, portName, port and targetPort are the corresponding fields from the 
    # k8s service defined above. The values below will make flagger create
    # the same service that would have been created by the commented out service
    # definition above.
    name: webflux-hw-service
    portName: http-webflux-hw-port
    port: 80
    targetPort: 8080
    # hosts, gateways and match are the corresponding fields from the 
    # istio virtualservice defined above. The values below will make flagger create
    # the same virtualservice that would have been created by the commented out 
    # virtualservice definition above. In addition, flagger will also create
    # istio destinationrules for the primary and canary services, see
    # https://docs.flagger.app/faq#istio-routing
    hosts:
      - 'webflux-hw.leiflindback.se'
    gateways:
      - istio-system/public-gateway
    match:
      - uri:
          prefix: /webflux-hw
  analysis:
    interval: 10s
    threshold: 10
    maxWeight: 50
    stepWeight: 5
    metrics:
      - name: request-success-rate
        thresholdRange:
          min: 99
        interval: 1m
      - name: request-duration
        thresholdRange:
          max: 500
        interval: 1m
    webhooks:
      - name: load-test
        url: http://flagger-loadtester.test/
        metadata:
          cmd: "hey -z 10s -q 10 -c 2 http://webflux-hw-service-canary.apps:80/"
